<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Chain Rock-Paper-Scissors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; color: #e9e9e9; }
        .container { max-width: 1000px; }
        .btn-move { transition: all 0.2s ease-in-out; }
        .btn-move:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-[#1a1a2e] text-[#e9e9e9] min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header and Balance Section -->
    <div class="container mx-auto p-6 bg-[#2c2c54] rounded-xl shadow-lg border border-[#4a4a75] mb-8">
        <h1 class="text-4xl font-bold text-center text-[#ffc600] mb-2">Rock-Paper-Scissors</h1>
        <p class="text-center text-gray-300 mb-6">Play against the chain and see if you can win!</p>
        
        <div class="flex flex-col md:flex-row items-center justify-between bg-[#3d3d6b] p-4 rounded-lg">
            <div id="status-display" class="flex items-center space-x-2">
                <span id="connection-status-icon" class="h-4 w-4 bg-red-500 rounded-full"></span>
                <span id="connection-status-text" class="text-sm">Disconnected</span>
            </div>
            <div id="balance-info" class="flex flex-col items-center md:items-end mt-4 md:mt-0 space-y-1">
                <p id="account-display" class="text-sm text-gray-400 truncate">Wallet: Not Connected</p>
                <p id="wallet-balance-display" class="text-sm text-gray-400">Your Balance: 0 STT</p>
                <p id="contract-balance-display" class="text-sm text-gray-400">Contract Balance: 0 STT</p>
            </div>
        </div>
    </div>

    <!-- Main Game Interface -->
    <div class="container mx-auto p-6 bg-[#2c2c54] rounded-xl shadow-lg border border-[#4a4a75]">
        <div class="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">

            <!-- Left Side: Player Betting Controls -->
            <div id="player-betting" class="flex-1 space-y-6">
                <h2 class="text-2xl font-semibold text-[#ffc600]">Your Bet</h2>

                <div id="connect-wallet-container" class="bg-[#3d3d6b] p-6 rounded-lg text-center">
                    <h3 class="text-xl font-semibold mb-4">Connect Your Wallet to Play</h3>
                    <button id="connect-wallet-btn" class="w-full px-6 py-3 bg-[#ffc600] text-[#1a1a2e] font-bold rounded-lg hover:bg-yellow-400 transition-colors">Connect Wallet</button>
                </div>

                <div id="game-controls" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm text-gray-400">Choose a stake amount:</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="btn-stake px-4 py-2 bg-[#4a4a75] rounded-lg hover:bg-[#5c5c8a] transition-colors" data-value="0.01">0.01 STT</button>
                                <button class="btn-stake px-4 py-2 bg-[#4a4a75] rounded-lg hover:bg-[#5c5c8a] transition-colors" data-value="0.05">0.05 STT</button>
                                <button class="btn-stake px-4 py-2 bg-[#4a4a75] rounded-lg hover:bg-[#5c5c8a] transition-colors" data-value="0.1">0.1 STT</button>
                                <button class="btn-stake px-4 py-2 bg-[#4a4a75] rounded-lg hover:bg-[#5c5c8a] transition-colors" data-value="1">1 STT</button>
                                <button class="btn-stake px-4 py-2 bg-[#4a4a75] rounded-lg hover:bg-[#5c5c8a] transition-colors" data-value="10">10 STT</button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <input type="number" id="stake-input" placeholder="Or enter custom stake" class="flex-1 p-3 rounded-lg bg-[#4a4a75] border border-[#5c5c8a] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#ffc600]">
                        </div>
                    </div>

                    <div class="mt-8">
                        <label class="block mb-2 text-sm text-gray-400">Choose your move:</label>
                        <div id="move-options" class="flex justify-around space-x-4">
                            <button data-move="0" class="btn-move p-4 bg-[#4a4a75] rounded-xl text-4xl hover:bg-[#5c5c8a]">✊</button>
                            <button data-move="1" class="btn-move p-4 bg-[#4a4a75] rounded-xl text-4xl hover:bg-[#5c5c8a]">✋</button>
                            <button data-move="2" class="btn-move p-4 bg-[#4a4a75] rounded-xl text-4xl hover:bg-[#5c5c8a]">✌️</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Game Result and Log -->
            <div class="flex-1 space-y-6 mt-8 md:mt-0 p-6 bg-[#3d3d6b] rounded-lg">
                <h2 class="text-2xl font-semibold text-[#ffc600]">Game Log</h2>
                <div id="game-log" class="space-y-4">
                    <p class="text-gray-400 text-center">Your game results will appear here.</p>
                </div>
            </div>

        </div>
    </div>
    
    <script type="text/javascript">
        const contractABI = [
            {
                "inputs": [],
                "name": "fund",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "playerMove",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "nukeMove",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "winner",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "winnings",
                        "type": "uint256"
                    }
                ],
                "name": "GamePlayed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_playerMove",
                        "type": "uint256"
                    }
                ],
                "name": "playGame",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const contractAddress = "0x245726E7AA5A5BDdf26DA2CAC3FC3911419477b9";

        let provider, signer, contract;
        let selectedStake = 0;
        let moveMap = ["Rock ✊", "Paper ✋", "Scissors ✌️"];

        const appendLog = (message, isError = false) => {
            const logContainer = document.getElementById('game-log');
            const newLog = document.createElement('p');
            newLog.className = `text-sm ${isError ? 'text-red-500' : 'text-gray-300'}`;
            newLog.innerHTML = message;
            logContainer.prepend(newLog);
            if (logContainer.children.length > 5) {
                logContainer.removeChild(logContainer.lastChild);
            }
        };

        const updateConnectionStatus = (isConnected) => {
            const statusIcon = document.getElementById('connection-status-icon');
            const statusText = document.getElementById('connection-status-text');
            if (isConnected) {
                statusIcon.classList.remove('bg-red-500');
                statusIcon.classList.add('bg-green-500');
                statusText.innerText = 'Connected';
            } else {
                statusIcon.classList.remove('bg-green-500');
                statusIcon.classList.add('bg-red-500');
                statusText.innerText = 'Disconnected';
            }
        };

        const updateBalanceDisplay = async (address) => {
            try {
                if (address) {
                    const balance = await provider.getBalance(address);
                    document.getElementById('account-display').innerText = `Wallet: ${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                    document.getElementById('wallet-balance-display').innerText = `Your Balance: ${ethers.utils.formatEther(balance)} STT`;
                } else {
                    document.getElementById('account-display').innerText = 'Wallet: Not Connected';
                    document.getElementById('wallet-balance-display').innerText = 'Your Balance: 0 STT';
                }
                if (contract) {
                    const contractBalance = await contract.getContractBalance();
                    document.getElementById('contract-balance-display').innerText = `Contract Balance: ${ethers.utils.formatEther(contractBalance)} STT`;
                }
            } catch (error) {
                console.error("Error updating balances:", error);
            }
        };

        const handleConnected = async (accounts) => {
             if (accounts.length > 0) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                updateConnectionStatus(true);
                updateBalanceDisplay(accounts[0]);
                document.getElementById('game-controls').classList.remove('hidden');
                document.getElementById('connect-wallet-container').classList.add('hidden');
            } else {
                updateConnectionStatus(false);
                updateBalanceDisplay(null);
                document.getElementById('connect-wallet-container').classList.remove('hidden');
                document.getElementById('game-controls').classList.add('hidden');
                provider = null;
                signer = null;
                contract = null;
            }
        };

        const connectWallet = async () => {
             if (typeof window.ethereum === 'undefined') {
                appendLog('Wallet Not Found: Please install a Web3 wallet like MetaMask to play this game.', true);
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleConnected(accounts);
            } catch (error) {
                console.error("User denied account access or other error:", error);
                appendLog('Connection Failed: Could not connect to wallet. Please try again.', true);
            }
        };
        
        const handlePlay = async (move) => {
            if (!signer) {
                appendLog("Wallet Required: Please connect your wallet to play.", true);
                return;
            }

            const stake = document.getElementById('stake-input').value || selectedStake;
            if (stake <= 0) {
                appendLog("Invalid Stake: Please enter a valid stake amount.", true);
                return;
            }
            
            appendLog(`Playing Game... you chose ${moveMap[move]} with a stake of ${stake} STT.`);

            try {
                const stakeWei = ethers.utils.parseEther(stake.toString());
                const tx = await contract.playGame(move, { value: stakeWei });
                appendLog(`Transaction sent: ${tx.hash}`);
                await tx.wait();
            } catch (error) {
                console.error("Error playing game:", error);
                appendLog("Transaction Failed: Could not play the game. Check your wallet and the network status.", true);
            }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.on('accountsChanged', handleConnected);
                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });

                document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);
                document.querySelectorAll('.btn-stake').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const stakeInput = document.getElementById('stake-input');
                        document.querySelectorAll('.btn-stake').forEach(b => b.classList.remove('bg-yellow-400'));
                        event.target.classList.add('bg-yellow-400');
                        selectedStake = parseFloat(event.target.dataset.value);
                        stakeInput.value = selectedStake;
                    });
                });
                document.getElementById('move-options').addEventListener('click', (event) => {
                    if (event.target.closest('button')) {
                        const move = event.target.closest('button').dataset.move;
                        handlePlay(move);
                    }
                });

                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                handleConnected(accounts);

                if (contractAddress !== "0x...YOUR_CONTRACT_ADDRESS...") {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    contract = new ethers.Contract(contractAddress, contractABI, provider);
                    contract.on("GamePlayed", (player, playerMove, nukeMove, winner, winnings) => {
                        let resultBody = "";
                        let resultColor = "";

                        if (winner == 1) {
                            resultBody = `<b>Result: You Won!</b><br>You played <b>${moveMap[playerMove]}</b>. The Random Draw played <b>${moveMap[nukeMove]}</b>. You received ${ethers.utils.formatEther(winnings)} STT.`;
                            resultColor = "text-green-400";
                        } else if (winner == 2) {
                            resultBody = `<b>Result: You Lost.</b><br>You played <b>${moveMap[playerMove]}</b>. The Random Draw played <b>${moveMap[nukeMove]}</b>. Better luck next time.`;
                            resultColor = "text-red-500";
                        } else {
                            resultBody = `<b>Result: It's a Draw.</b><br>You played <b>${moveMap[playerMove]}</b>. The Random Draw also played <b>${moveMap[nukeMove]}</b>. Your stake has been returned.`;
                            resultColor = "text-yellow-400";
                        }
                        
                        appendLog(resultBody);
                        
                        if (provider && signer) {
                            signer.getAddress().then(address => updateBalanceDisplay(address));
                        }
                    });
                }
            } else {
                updateConnectionStatus(false);
                document.getElementById('connect-wallet-container').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-red-500">Wallet Not Found</h2><p class="text-gray-300">Please install a Web3 wallet like MetaMask to play this game.</p>`;
            }
        });
    </script>
</body>
</html>
